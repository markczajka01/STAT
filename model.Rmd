---
title: "Modelling Code"
author: "Group"
date: "`r Sys.Date()`"
output: html_document
---

```{r libraries}
# Suppress start up warnings when loading libraries
library <- function(...) {
  suppressPackageStartupMessages(base::library(...))
}
# Load in all libraries
library(tidyverse)
library(here) # directory referencing
library(MASS)
library(nnet)
library(randomForest)
library(caret)
```

# Load data from data_transformation.Rmd
```{r}
load(file = here("data", "model_data.Rdata"))
```

# Part 1 of 3: LDL
## 1.1 GLM on LDL_status
```{r}
glm_LDL <- glm(LDL_status ~  whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, family = "binomial", data = model_data)
summary(glm_LDL)
```

## 1.2 Ordinal on LDL_band
```{r}
ordinal_LDL <- polr(LDL_band ~ whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, data = model_data)
summary(ordinal_LDL)
ctable <- coef(summary(ordinal_LDL))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)
ctable
```


## 1.3 multinomial on LDL_band
```{r}
multinom_LDL <- multinom(LDL_band ~ whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, data = model_data, trace=FALSE)
summary(multinom_LDL)
coef(summary(multinom_LDL))
# calculate p-values
zvalues <- summary(multinom_LDL)$coefficients / summary(multinom_LDL)$standard.errors
pnorm(abs(zvalues), lower.tail=FALSE)*2
```

# Part 2 of 3: HDL
## 2.1 GLM on HDL_status
```{r}
glm_HDL <- glm(HDL_status ~  whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, family = "binomial", data = model_data)
summary(glm_HDL)
```


## 2.2 Ordinal on HDL_band
```{r}
ordinal_HDL <- polr(HDL_band ~ whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, data = model_data)
summary(ordinal_HDL)
ctable <- coef(summary(ordinal_HDL))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)
ctable
```


## 2.3 multinomial on HDL_band
```{r}
multinom_HDL <- multinom(HDL_band ~ whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, data = model_data, trace=FALSE)
summary(multinom_HDL)
coef(summary(multinom_HDL))
# calculate p-values
zvalues <- summary(multinom_HDL)$coefficients / summary(multinom_HDL)$standard.errors
pnorm(abs(zvalues), lower.tail=FALSE)*2
```


# Part 3 of 3: CHOL (Total cholesterol)
## 3.1 GLM on total_cholesterol_status
```{r}
glm_CHOL <- glm(total_cholesterol_status ~  whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, family = "binomial", data = model_data)
summary(glm_CHOL)
```


## 3.2 Ordinal on total_cholesterol_band
```{r}
ordinal_CHOL <- polr(total_cholesterol_band ~ whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, data = model_data)
summary(ordinal_CHOL)
ctable <- coef(summary(ordinal_CHOL))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)
ctable
```


## 3.3 multinomial on total_cholesterol_band
```{r}
multinom_CHOL <- multinom(total_cholesterol_band ~ whole_grain + refined_grain + fibre + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration, data = model_data, trace=FALSE)
summary(multinom_CHOL)
coef(summary(multinom_CHOL))
# calculate p-values
zvalues <- summary(multinom_CHOL)$coefficients / summary(multinom_CHOL)$standard.errors
pnorm(abs(zvalues), lower.tail=FALSE)*2
```


## Saving Models as another R object to use in confusion_matrices.Rmd etc

```{r}

save(
  glm_LDL,
  glm_HDL,
  glm_CHOL,
  ordinal_LDL,
  ordinal_HDL,
  ordinal_CHOL,
  multinom_LDL,
  multinom_HDL,
  multinom_CHOL,
  file = "models.Rdata"
)

```



## RF
## Kieran: didn't finish fixing this since we're not using it in the presentation
```{r}
model_data$LDL_band_NUM <- as.numeric(model_data$LDL_band)

classes <-  c(merged_data$LDL_band)

breaks <- c(-Inf, 2, 5, 8)

label <- c("Ridiculous", "Ludicrous", "Plaid")

merged_data$grouped_LDL_band <- cut(merged_data$LDL_band, breaks = breaks, labels = label)

train_indices <- sample(1:nrow(merged_data), 0.8 * nrow(merged_data)) 
train_data <- merged_data[train_indices, ]
test_data <- merged_data[-train_indices, ]

forest_gump <- randomForest(grouped_LDL_band ~ whole_grain + refined_grain + BMI + age + sleep_time + systolic_blood_pressure, data = train_data, ntree = 500, importance = TRUE)
predictions <- predict(forest_gump, newdata = test_data)

forest_gump
```


```{r}
varImpPlot(forest_gump, main="Model Performance Predicting LDL_band Response")
```


# LDL_status
## multinomial
```{r}
nom_nom_2 <- multinom(LDL_status ~ whole_grain + refined_grain + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration + HDL_band + total_cholesterol_band, data = model_data, trace=FALSE)
summary(nom_nom_2)

zvalues <- summary(nom_nom_2)$coefficients / summary(nom_nom_2)$standard.errors

# calculate p-values
pnorm(abs(zvalues), lower.tail=FALSE)*2
```

## RF
```{r}
forest_gump_sequel <- randomForest(LDL_status ~ whole_grain + whole_grain_PROP + refined_grain + BMI + age + sleep_time + systolic_blood_pressure, data = train_data, ntree = 500, importance = TRUE)
predictions <- predict(forest_gump_sequel, newdata = test_data)

forest_gump_sequel
```

```{r}
varImpPlot(forest_gump_sequel, main="Model Performance Predicting LDL_status Response")
```



# HDL_band

## ordinal
```{r}

ordinal_3 <- polr(LDL_band ~ whole_grain + refined_grain + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration + HDL_band, data = model_data)
summary(ordinal_3)
ctable <- coef(summary(ordinal_3))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)
ctable
```


## multinomial on HDL_band
```{r}
nom_nom_3 <- multinom(LDL_band ~ whole_grain  + refined_grain + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration + HDL_band, data = model_data, trace=FALSE)
summary(nom_nom_3)

# calculate p-values
zvalues <- summary(nom_nom_3)$coefficients / summary(nom_nom_3)$standard.errors
pnorm(abs(zvalues), lower.tail=FALSE)*2
```

## RF

```{r}
train_indices_1 <- sample(1:nrow(model_data), 0.8 * nrow(model_data)) 
train_data_1 <- model_data[train_indices_1, ]
test_data_1 <- model_data[-train_indices_1, ]

forest_gump_trilogy <- randomForest(LDL_band ~ whole_grain + refined_grain + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration + HDL_band, data = train_data_1, ntree = 500, importance = TRUE)
predictions <- predict(forest_gump_trilogy, newdata = test_data_1)

forest_gump_trilogy
```


# total_cholesterol_band
## ordinal

```{r}
ordinal_4 <- polr(total_cholesterol_band ~ whole_grain + refined_grain + BMI + age + sleep_time + systolic_blood_pressure + exercise_duration + HDL_band, data = model_data)
summary(ordinal_4)
ctable <- coef(summary(ordinal_4))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)
ctable
```

